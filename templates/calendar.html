{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-neutral">Reservation Calendar</h1>
        <div class="flex gap-2">
            <input type="text" id="calendarFilter" placeholder="Filter property..."
                class="px-4 py-2 border border-gray-200 rounded-xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary w-48">
            <script>
                document.getElementById('calendarFilter').addEventListener('keyup', function (e) {
                    const text = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('.calendar-row');
                    rows.forEach(row => {
                        const titleDiv = row.querySelector('.prop-title');
                        if (titleDiv) {
                            const title = titleDiv.textContent.toLowerCase();
                            if (title.includes(text)) {
                                row.classList.remove('hidden');
                            } else {
                                row.classList.add('hidden');
                            }
                        }
                    });
                });
            </script>
            <button onclick="toggleModal('bookingModal')"
                class="bg-primary hover:bg-[#E00B41] text-white px-4 py-2 rounded-xl text-sm font-medium transition-colors shadow-lg shadow-primary/30">
                New Reservation
            </button>
        </div>
    </div>

    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
            <h2 class="font-bold text-lg text-neutral">{{ month_name }} {{ current_year }}</h2>
            <div class="flex gap-2">
                <a href="/calendar?year={{ prev_year }}&month={{ prev_month }}"
                    class="p-2 hover:bg-gray-100 rounded-lg text-neutral transition-colors">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                </a>
                <a href="/calendar?year={{ next_year }}&month={{ next_month }}"
                    class="p-2 hover:bg-gray-100 rounded-lg text-neutral transition-colors">
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </a>
            </div>
        </div>

        <div class="overflow-x-auto">
            <div class="min-w-max">
                <!-- Header: Days -->
                <div class="flex border-b border-gray-100 bg-gray-50/50">
                    <div
                        class="w-48 p-4 text-xs font-semibold uppercase text-gray-500 shrink-0 sticky left-0 bg-gray-50 z-10 border-r border-gray-100">
                        Property</div>
                    {% for day in range(1, days_in_month + 1) %}
                    <div
                        class="w-12 p-2 text-center text-xs font-semibold text-gray-500 border-r border-gray-100 shrink-0">
                        {{ day }}
                    </div>
                    {% endfor %}
                </div>

                <!-- Rows -->
                {% for prop in properties %}
                <div
                    class="flex border-b border-gray-50 last:border-0 hover:bg-gray-50/50 transition-colors calendar-row">
                    <div
                        class="w-48 p-4 font-medium text-sm text-neutral truncate border-r border-gray-50 shrink-0 sticky left-0 bg-white z-10 prop-title">
                        {{ prop.title }}
                    </div>
                    {% for day in range(1, days_in_month + 1) %}
                    <div class="w-12 h-14 border-r border-gray-50/50 relative shrink-0">
                        {% for res in reservations %}
                        {% if res.property_id == prop.id %}
                        {# Check if this reservation covers current day #}
                        {% if res.check_in.year == current_year and res.check_in.month == current_month %}
                        {% if day >= res.check_in.day and day < res.check_out.day %} {# Start of block #} {% if
                            day==res.check_in.day %} <div
                            class="absolute top-1 left-1 bottom-1 z-20 bg-primary text-white text-[9px] font-bold p-1 rounded-l-md overflow-hidden whitespace-nowrap shadow-sm"
                            style="width: {{ (res.check_out.day - res.check_in.day) * 3 }}rem;">
                            {{ res.guest_name }}
                    </div>
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
</div>

<!-- Booking Modal (Reused) -->
<div id="bookingModal" class="hidden fixed inset-0 bg-black/50 z-50 flex justify-center items-center backdrop-blur-sm">
    <div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl animate-fade-in relative">
        <button onclick="toggleModal('bookingModal')" class="absolute top-4 right-4 text-gray-400 hover:text-neutral">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>

        <h2 class="text-2xl font-bold text-neutral mb-6">New Booking</h2>

        <form action="/add_reservation" method="POST" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Property</label>
                <select name="property_id" required
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                    {% for prop in properties %}
                    <option value="{{ prop.id }}">{{ prop.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Guest Name</label>
                <input type="text" name="guest_name" required placeholder="John Doe"
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Check In</label>
                    <input type="date" name="check_in" required
                        class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Check Out</label>
                    <input type="date" name="check_out" required
                        class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Amount Paid ($)</label>
                <input type="number" name="amount_paid" required step="0.01" placeholder="0.00"
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
            </div>

            <button type="submit"
                class="w-full bg-primary hover:bg-[#E00B41] text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/30 mt-2 transition-all">
                Confirm Booking
            </button>
        </form>
    </div>
</div>
{% endblock %}