{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-neutral">Dashboard</h1>
        <div class="text-sm text-gray-500">Welcome back, {{ session.user.name }}</div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- RevPAR -->
        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-red-50 text-primary rounded-lg">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                </div>
                <span class="text-xs font-semibold px-2 py-1 bg-green-100 text-green-700 rounded-full">+12%</span>
            </div>
            <h3 class="text-gray-500 text-sm font-medium">RevPAR (30 Days)</h3>
            <div class="text-2xl font-bold text-neutral mt-1">$<span id="kpi-revpar">{{ revpar }}</span></div>
        </div>

        <!-- Occupancy -->
        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                    <i data-lucide="home" class="w-5 h-5"></i>
                </div>
            </div>
            <h3 class="text-gray-500 text-sm font-medium">Occupancy Rate</h3>
            <div class="text-2xl font-bold text-neutral mt-1"><span id="kpi-occupancy">{{ occupancy }}</span>%</div>
        </div>

        <!-- Net Profit -->
        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="p-2 bg-green-50 text-green-600 rounded-lg">
                    <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                </div>
            </div>
            <h3 class="text-gray-500 text-sm font-medium">Net Profit (Approx)</h3>
            <div class="text-2xl font-bold text-neutral mt-1">$<span id="kpi-profit">{{ net_profit }}</span></div>
        </div>

        <!-- Active Alerts Badge -->
        <div class="bg-neutral text-white p-6 rounded-2xl shadow-lg">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-white"></i>
                </div>
                <h3 class="font-semibold">System Alerts</h3>
            </div>
            <div class="text-3xl font-bold">{{ alerts|length }}</div>
            <p class="text-sm text-white/70 mt-1">Requires attention</p>
        </div>
    </div>

    <!-- Alerts Section -->
    {% if alerts %}
    <div class="bg-white border border-gray-200 p-6 rounded-2xl">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 text-gray-600 mt-0.5"></i>
            <div class="flex-1">
                <h3 class="font-bold text-neutral mb-3">AI Monitoring Active</h3>
                <div class="space-y-2">
                    {% for alert in alerts %}
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                        <div>
                            <span class="text-xs font-semibold text-gray-600 uppercase">{{ alert.type }}</span>
                            <p class="text-sm text-gray-700 mt-1">{{ alert.message }}</p>
                        </div>
                        <a href="{{ alert.action_url }}"
                            class="text-primary hover:underline text-sm font-medium">View</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Revenue Chart - Full Width at Top -->
    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
        <div class="flex gap-2 items-center mb-4">
            <div class="bg-gray-50 p-2 rounded-full">
                <i data-lucide="bar-chart-2" class="w-5 h-5 text-gray-500"></i>
            </div>
            <h3 class="text-neutral font-bold">Revenue Trends</h3>
        </div>
        <div class="h-96">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left Column: Activity Feeds -->
        <div class="col-span-12 lg:col-span-8">
            <!-- Activity Feeds Stacked -->
            <div class="space-y-4">
                <!-- Operations Activity Feed -->
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-100">
                        <div>
                            <h2 class="text-base font-semibold text-neutral">Operations Activity</h2>
                            <p class="text-xs text-gray-500 mt-1">Property management</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <span class="text-xs font-medium text-green-600">Live</span>
                        </div>
                    </div>
                    <div class="h-80 overflow-y-auto space-y-2" id="operations-logs">
                        {% for log in operations_logs %}
                        <div class="flex gap-3 p-2.5 hover:bg-gray-50 rounded-lg transition-colors border-l-2 
                            {% if log.category == 'Booking' %}border-green-400 bg-green-50/20
                            {% elif log.category == 'Alert' %}border-yellow-400 bg-yellow-50/20
                            {% elif log.category == 'Maintenance' %}border-blue-400 bg-blue-50/20
                            {% else %}border-gray-300 bg-gray-50/20{% endif %}">
                            <div class="shrink-0">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs
                                    {% if log.category == 'Booking' %}bg-green-100 text-green-600
                                    {% elif log.category == 'Alert' %}bg-yellow-100 text-yellow-600
                                    {% elif log.category == 'Maintenance' %}bg-blue-100 text-blue-600
                                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                                    {% if log.category == 'Booking' %}
                                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                                    {% elif log.category == 'Alert' %}
                                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                                    {% elif log.category == 'Maintenance' %}
                                    <i data-lucide="tool" class="w-4 h-4"></i>
                                    {% else %}
                                    <i data-lucide="activity" class="w-4 h-4"></i>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-neutral leading-snug">{{ log.message }}</p>
                                <p class="text-xs text-gray-400 mt-1">{{ log.timestamp.strftime('%I:%M:%S %p') }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Pricing Decisions Feed -->
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-100">
                        <div>
                            <h2 class="text-base font-semibold text-neutral">AI Pricing Decisions</h2>
                            <p class="text-xs text-gray-500 mt-1">Revenue optimization</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-primary rounded-full animate-pulse"></span>
                            <span class="text-xs font-medium text-primary">Live</span>
                        </div>
                    </div>
                    <div class="h-80 overflow-y-auto space-y-2" id="pricing-logs">
                        {% for log in pricing_logs %}
                        <div
                            class="flex gap-3 p-3 hover:bg-gray-50 rounded-xl transition-colors border-l-2 border-primary bg-red-50/20">
                            <div class="shrink-0">
                                <div
                                    class="w-8 h-8 rounded-full flex items-center justify-center text-xs bg-red-100 text-primary">
                                    <i data-lucide="trending-up" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-neutral leading-snug">{{ log.message }}</p>
                                <p class="text-xs text-gray-400 mt-1">{{ log.timestamp.strftime('%I:%M:%S %p') }}</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-8 text-gray-400">
                            <i data-lucide="zap" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                            <p class="text-sm">Waiting for pricing decisions...</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Priority & Staff -->
        <div class="col-span-12 lg:col-span-3 space-y-6">
            <!-- Cleaning Priority -->
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-neutral">Cleaning Priority</h2>
                    <button class="text-xs text-gray-400 hover:text-primary">View All</button>
                </div>
                <div class="space-y-4">
                    {% for task in cleaning_tasks %}
                    <div class="flex items-center gap-4 py-2 border-b border-gray-50 last:border-0">
                        <div
                            class="w-2 h-2 rounded-full {{ 'bg-red-500' if task.status == 'Dirty' else 'bg-yellow-500' }}">
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-neutral">{{ task.property }}</h4>
                            <div class="flex items-center gap-2 mt-0.5">
                                <i data-lucide="calendar" class="w-3 h-3 text-gray-400"></i>
                                <p class="text-xs text-gray-500">In: {{ task.check_in.strftime('%b %d') }}</p>
                            </div>
                        </div>
                        <span class="text-xs font-medium px-2 py-1 bg-gray-100 rounded-lg text-gray-600">{{ task.status
                            }}</span>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500">No immediate cleaning tasks.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Staff List -->
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
                <h2 class="text-lg font-bold text-neutral mb-4">Active Staff</h2>
                <div class="space-y-3">
                    {% for s in staff %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">
                                {{ s.name[0] }}
                            </div>
                            <div>
                                <p class="text-sm font-medium text-neutral">{{ s.name }}</p>
                                <p class="text-xs text-gray-500">{{ s.role }}</p>
                            </div>
                        </div>
                        <a href="tel:{{ s.contact }}" class="p-2 text-primary hover:bg-red-50 rounded-full"><i
                                data-lucide="phone" class="w-4 h-4"></i></a>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500">No staff added yet.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
                <h2 class="text-lg font-bold text-neutral mb-4">Quick Actions</h2>
                <div class="space-y-2">
                    <button onclick="toggleModal('staffModal')"
                        class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-sm font-medium text-neutral transition-colors flex items-center gap-3">
                        <i data-lucide="user-plus" class="w-4 h-4 text-primary"></i>
                        Add Staff
                    </button>
                    <button
                        class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-sm font-medium text-neutral transition-colors flex items-center gap-3">
                        <i data-lucide="file-text" class="w-4 h-4 text-primary"></i>
                        Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="hidden fixed inset-0 bg-black/50 z-50 flex justify-center items-center backdrop-blur-sm">
    <div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl animate-fade-in relative">
        <button onclick="toggleModal('bookingModal')" class="absolute top-4 right-4 text-gray-400 hover:text-neutral">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>

        <h2 class="text-2xl font-bold text-neutral mb-6">New Booking</h2>

        <form action="/add_reservation" method="POST" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Property</label>
                <select name="property_id" required
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                    {% for prop in properties %}
                    <option value="{{ prop.id }}">{{ prop.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Guest Name</label>
                <input type="text" name="guest_name" required placeholder="John Doe"
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Check In</label>
                    <input type="date" name="check_in" required
                        class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Check Out</label>
                    <input type="date" name="check_out" required
                        class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Amount Paid ($)</label>
                <input type="number" name="amount_paid" required step="0.01" placeholder="0.00"
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
            </div>

            <button type="submit"
                class="w-full bg-primary hover:bg-[#E00B41] text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/30 mt-2 transition-all">
                Confirm Booking
            </button>
        </form>
    </div>
</div>

<!-- Staff Modal -->
<div id="staffModal" class="hidden fixed inset-0 bg-black/50 z-50 flex justify-center items-center backdrop-blur-sm">
    <div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl animate-fade-in relative">
        <button onclick="toggleModal('staffModal')" class="absolute top-4 right-4 text-gray-400 hover:text-neutral">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
        <h2 class="text-2xl font-bold text-neutral mb-6">Add Staff Member</h2>
        <form action="/add_staff" method="POST" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                <input type="text" name="name" required placeholder="Alice Smith"
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                <select name="role"
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
                    <option value="Manager">Manager</option>
                    <option value="Cleaner">Cleaner</option>
                    <option value="Maintenance">Maintenance</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                <input type="text" name="contact" required placeholder="+1 234 567 890"
                    class="w-full border border-gray-200 rounded-xl px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
            </div>
            <button type="submit"
                class="w-full bg-primary hover:bg-[#E00B41] text-white font-bold py-3 rounded-xl shadow-lg shadow-primary/30 mt-2 transition-all">
                Add Staff
            </button>
        </form>
    </div>
</div>

<!-- Simulation Poller -->
<script>
    let revenueChartInstance = null;

    setInterval(function () {
        fetch('/api/simulate')
            .then(response => response.json())
            .then(data => {
                // Update KPIs
                document.getElementById('kpi-revpar').innerText = data.revpar;
                document.getElementById('kpi-occupancy').innerText = data.occupancy;
                document.getElementById('kpi-profit').innerText = data.net_profit;

                // Update Chart
                if (revenueChartInstance) {
                    revenueChartInstance.data.labels = data.chart_labels;
                    revenueChartInstance.data.datasets[0].data = data.chart_data;
                    revenueChartInstance.update();
                }

                // Update Operations Logs
                if (data.operations_logs) {
                    const opsContainer = document.getElementById('operations-logs');
                    let html = '';
                    data.operations_logs.forEach(log => {
                        let borderColor = 'border-gray-300 bg-gray-50/20';
                        let iconBg = 'bg-gray-100 text-gray-600';
                        let icon = 'activity';

                        if (log.category === 'Booking') {
                            borderColor = 'border-green-400 bg-green-50/20';
                            iconBg = 'bg-green-100 text-green-600';
                            icon = 'check-circle';
                        } else if (log.category === 'Alert') {
                            borderColor = 'border-yellow-400 bg-yellow-50/20';
                            iconBg = 'bg-yellow-100 text-yellow-600';
                            icon = 'alert-triangle';
                        } else if (log.category === 'Maintenance') {
                            borderColor = 'border-blue-400 bg-blue-50/20';
                            iconBg = 'bg-blue-100 text-blue-600';
                            icon = 'tool';
                        }

                        html += `
                            <div class="flex gap-3 p-2.5 hover:bg-gray-50 rounded-lg transition-colors border-l-2 ${borderColor}">
                                <div class="shrink-0">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs ${iconBg}">
                                        <i data-lucide="${icon}" class="w-4 h-4"></i>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-neutral leading-snug">${log.message}</p>
                                    <p class="text-xs text-gray-400 mt-1">${log.time}</p>
                                </div>
                            </div>
                        `;
                    });
                    opsContainer.innerHTML = html;
                    lucide.createIcons();
                }

                // Update Pricing Logs
                if (data.pricing_logs) {
                    const pricingContainer = document.getElementById('pricing-logs');
                    let html = '';
                    if (data.pricing_logs.length > 0) {
                        data.pricing_logs.forEach(log => {
                            html += `
                                <div class="flex gap-3 p-2.5 hover:bg-gray-50 rounded-lg transition-colors border-l-2 border-primary bg-red-50/10">
                                    <div class="shrink-0">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs bg-red-100 text-primary">
                                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm text-neutral leading-snug">${log.message}</p>
                                        <p class="text-xs text-gray-400 mt-1">${log.time}</p>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html = `
                            <div class="text-center py-8 text-gray-400">
                                <i data-lucide="zap" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                                <p class="text-sm">Waiting for pricing decisions...</p>
                            </div>
                        `;
                    }
                    pricingContainer.innerHTML = html;
                    lucide.createIcons();
                }

                if (data.new_event) {
                    const toast = document.createElement('div');
                    toast.className = "fixed bottom-4 right-4 bg-neutral text-white px-6 py-4 rounded-xl shadow-2xl animate-fade-in z-50 flex items-center gap-3";
                    toast.innerHTML = `<i data-lucide="bell" class="w-5 h-5 text-primary"></i> <div><p class="font-bold text-sm">New Activity</p><p class="text-xs text-gray-400">${data.message}</p></div>`;
                    document.body.appendChild(toast);
                    lucide.createIcons();
                    setTimeout(() => toast.remove(), 5000);
                }
            });
    }, 1000); // Poll every 1 second

    // Auto-dismiss standard alerts
    setTimeout(function () {
        const alerts = document.querySelectorAll('.animate-fade-in');
        alerts.forEach(alert => {
            if (alert.parentElement.classList.contains('mb-6')) {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }
        });
    }, 5000);
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        const chartLabels = JSON.parse('{{ chart_labels | tojson | safe }}');
        const chartData = JSON.parse('{{ chart_data | tojson | safe }}');

        revenueChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Revenue ($)',
                    data: chartData,
                    borderColor: '#FF385C',
                    backgroundColor: 'rgba(255, 56, 92, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                    x: { grid: { display: false } }
                }
            }
        });
    });
</script>
{% endblock %}